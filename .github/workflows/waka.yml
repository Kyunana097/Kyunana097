name: Waka Readme

on:
  schedule:
    - cron: '30 22 * * *'
  workflow_dispatch:
jobs:
  update-readme:
    name: Update Readme with Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: anmol098/waka-readme-stats@master
        env:
          TZ: Asia/Shanghai
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          LOCALE: zh
          SHOW_LINES_OF_CODE: "True" # 显示截至日期写入的代码行数
          SHOW_LOC_CHART: "False" # 年份不同季度编写的代码行数
          SHOW_SHORT_INFO: "False" # 用户的简短趣闻信息
          SHOW_OS: "True" # 显示系统
          SHOW_PROJECTS: "True" # 显示项目
          SHOW_TOTAL_CODE_TIME: "True" # 显示总编码时间
          SHOW_COMMIT: "True" # 显示提交信息
          SHOW_PROFILE_VIEWS: "False" # 设置为隐藏配置文件视图
          SHOW_DAYS_OF_WEEK: "True"  # 一周中不同日期进行的提交
          SHOW_LANGUAGE: "True" # 编码语言
          SHOW_EDITORS: "True" # 编辑器
          SHOW_LANGUAGE_PER_REPO: "False" # 显示每个仓库的编程语言分布
          SYMBOL_VERSION: "2" # 设置进度条的符号样式 (0,1,2)
          
          # ========== 其他显示选项 ==========
          SHOW_UPDATED_DATE: "True" # 显示最后更新日期
          UPDATED_DATE_FORMAT: "%d/%m/%Y %H:%M:%S %Z" # 指定格式并包含时区名称
          
          # 注: Timeline 背景颜色需要通过以下方式自定义:
          # 1. 在 README.md 中使用 HTML/CSS 修改
          # 2. 或在生成的图表中使用 HTML 标签设置样式
          # 3. 该 action 的主题颜色通常由 WakaTime API 返回的数据决定
      - name: Checkout repository (for post-processing)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Convert README timestamp to Asia/Shanghai (UTC+8)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          python - <<'PY'
          import re, sys
          from datetime import datetime, timezone
          try:
              from zoneinfo import ZoneInfo
          except Exception:
              from backports.zoneinfo import ZoneInfo

          path='README.md'
          txt=open(path,encoding='utf-8').read()
          # match patterns like: Last Updated on 11/12/2025 12:49:53 UTC
          m=re.search(r'(Last Updated on )([0-9]{1,2}/[0-9]{1,2}/[0-9]{4} [0-9]{2}:[0-9]{2}:[0-9]{2}) UTC',txt)
          if not m:
              print('No matching timestamp found; skipping')
              sys.exit(0)
          old=m.group(2)
          dt=datetime.strptime(old,'%d/%m/%Y %H:%M:%S').replace(tzinfo=timezone.utc)
          tz=ZoneInfo('Asia/Shanghai')
          new=dt.astimezone(tz).strftime('%d/%m/%Y %H:%M:%S %Z')
          new_txt=txt.replace(m.group(0), f'Last Updated on {new}')
          if new_txt==txt:
              print('Timestamp already in target timezone')
              sys.exit(0)
          open(path,'w',encoding='utf-8').write(new_txt)
          print('README timestamp converted to', new)
          PY

      - name: Commit and push README change (skip CI)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config user.name "readme-postprocess"
          git config user.email "readme-postprocess@users.noreply.github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No README changes to commit"
          else
            git commit -m "Update README timestamp [skip ci]"
            git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }} HEAD:${GITHUB_REF#refs/heads/}
          fi
